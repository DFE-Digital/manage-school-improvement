@page "/engagement-concern/{id:int}"
@using Dfe.Academisation.ExtensionMethods
@model IndexModel

@{
    ViewData["Title"] = "Engagement concern";
}

@section BeforeMain
{
    <a asp-page="@Model.ReturnPage" class="govuk-back-link">@Links.SchoolList.Index.BackText</a>
    @if (Model.EngagementConcernRecorded is true || Model.EngagementConcernUpdated is true || Model.EngagementConcernRemoved is true
|| Model.InformationPowersRecorded is true || Model.InformationPowersRemoved is true)
    {
        <div class="govuk-notification-banner govuk-notification-banner--success" role="alert" aria-labelledby="govuk-notification-banner-title" data-module="govuk-notification-banner" cy-data="task-updated-success-notification">
            <div class="govuk-notification-banner__header">
                <h2 class="govuk-notification-banner__title" id="govuk-notification-banner-title">
                    Success
                </h2>
            </div>
            <div class="govuk-notification-banner__content">
                <h3 class="govuk-notification-banner__heading" id="case-study-message">
                    @(Model.EngagementConcernRecorded is true ? "Engagement concern recorded" : "")
                    @(Model.EngagementConcernUpdated is true ? "Engagement concern updated" : "")
                    @(Model.EngagementConcernRemoved is true ? "Engagement concern removed" : "")
                    @(Model.InformationPowersRecorded is true ? "Use of information powers recorded" : "")
                    @(Model.InformationPowersRemoved is true ? "Information powers removed" : "")
                </h3>
            </div>
        </div>
    }
}
<partial name="_ProjectHeader" model="Model.SupportProject" />
<div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">
        @if (Model.SupportProject.EngagementConcernRecorded is true)
        {
            <div class="govuk-summary-card">
                <div class="govuk-summary-card__title-wrapper">
                    <h2 class="govuk-summary-card__title">
                        Engagement concern
                    </h2>
                </div>
                <div class="govuk-summary-card__content">
                    <dl class="govuk-summary-list">
                        <div class="govuk-summary-list__row">
                            <dt class="govuk-summary-list__key">
                                Date raised
                            </dt>
                            <dd class="govuk-summary-list__value">
                                @Model.DateRaised.ToDateString()
                            </dd>
                        </div>
                        <div class="govuk-summary-list__row">
                            <dt class="govuk-summary-list__key">
                                Escalated?
                            </dt>
                            <dd class="govuk-summary-list__value">
                                @(Model.EngagementConcernEscalated ? "Yes" : "No")
                            </dd>
                        </div>

                        @if (Model.EngagementConcernEscalated)
                        {
                            <div class="govuk-summary-list__row">
                                <dt class="govuk-summary-list__key">
                                    Reason
                                </dt>
                                <dd class="govuk-summary-list__value">
                                    @Model.EngagementConcernEscalationReason
                                </dd>
                                @* <dd class="govuk-summary-list__actions"> *@
                                @* <a class="govuk-link govuk-!-padding-left-50" *@
                                @*    asp-page="@Links.EngagementConcern.ReasonForEscalation.Page" *@
                                @*    asp-page-handler="ChangeLink" *@
                                @*    asp-route-id="@Model.SupportProject.Id" *@
                                @*    asp-route-returnUrl="@Model.HttpContext.Request.Path@Model.HttpContext.Request.QueryString" *@
                                @*    asp-route-returnpage="@Links.EngagementConcern.Index.Page"> *@
                                @*     Change<span class="govuk-visually-hidden">Change</span> *@
                                @* </a> *@
                                @* </dd> *@
                                <dd class="govuk-summary-list__actions">
                                    <form method="post" asp-page-handler="ChangeLink">
                                        @* <input type="hidden" name="id" value="@Model.SupportProject.Id" /> *@
                                        @* $1$ <input type="hidden" name="returnUrl" value="@Model.HttpContext.Request.Path@Model.HttpContext.Request.QueryString" /> #1# *@
                                        @* <input type="hidden" name="nextPage" value="@Links.EngagementConcern.ReasonForEscalation.Page" /> *@
                                        @* <button type="submit" class="govuk-link govuk-!-padding-left-50" style="border:none; background:none; cursor:pointer;"> *@
                                        @*     Change<span class="govuk-visually-hidden">Change</span> *@
                                        @* </button> *@
                                        @* <a class="govuk-link govuk-!-padding-left-50" *@
                                        @*    asp-page="@Links.EngagementConcern.ReasonForEscalation.Page" *@
                                        @*    asp-route-id="@Model.SupportProject.Id" *@
                                        @*    asp-route-returnUrl="@Model.HttpContext.Request.Path@Model.HttpContext.Request.QueryString" *@
                                        @*    asp-route-nextPage="@Links.EngagementConcern.Index.Page"> *@
                                        @*     Change<span class="govuk-visually-hidden">Change</span> *@
                                        @* </a> *@
                                        <a class="govuk-link govuk-!-padding-left-50"
                                           onclick="submitChangeLink(event)"
                                           data-id="@Model.SupportProject.Id"
                                           data-return-url="@Model.HttpContext.Request.Path@Model.HttpContext.Request.QueryString"
                                           data-return-page="@Links.EngagementConcern.Index.Page"
                                           href="javascript:void(0);">
                                            Change<span class="govuk-visually-hidden">Change</span>
                                        </a>
                                    </form>
                                </dd>
                            </div>
                            <div class="govuk-summary-list__row">
                                <dt class="govuk-summary-list__key">
                                    Date escalated
                                </dt>
                                <dd class="govuk-summary-list__value">
                                    @Model.DateEscalated.ToDateString()
                                </dd>
                                @* <dd class="govuk-summary-list__actions"> *@
                                @*     <a class="govuk-link govuk-!-padding-left-50"  *@
                                @*        asp-page="@Links.EngagementConcern.DateOfDecision.Page" *@
                                @*        asp-page-handler="ChangeLink" *@
                                @*        asp-route-id="@Model.SupportProject.Id" *@
                                @*        asp-route-returnUrl="@Model.HttpContext.Request.Path@Model.HttpContext.Request.QueryString" *@
                                @*        asp-route-returnpage="@Links.EngagementConcern.Index.Page"> *@
                                @*         Change<span class="govuk-visually-hidden">Change</span> *@
                                @*     </a> *@
                                @* </dd> *@
                                <dd class="govuk-summary-list__actions">
                                    <a class="govuk-link govuk-!-padding-left-50"
                                       asp-page="@Links.EngagementConcern.DateOfDecision.Page"
                                       asp-page-handler="ChangeLink"
                                       asp-route-id="@Model.SupportProject.Id"
                                       asp-route-returnUrl="@Model.HttpContext.Request.Path@Model.HttpContext.Request.QueryString"
                                       asp-route-returnpage="@Links.EngagementConcern.Index.Page">
                                        Change<span class="govuk-visually-hidden">Change</span>
                                    </a>
                                </dd>
                                @* <dd class="govuk-summary-list__actions"> *@
                                @*     <form method="post" asp-page-handler="ChangeLink"> *@
                                @*         <input type="hidden" name="id" value="@Model.SupportProject.Id" /> *@
                                @*         $1$ <input type="hidden" name="returnUrl" value="@Model.HttpContext.Request.Path@Model.HttpContext.Request.QueryString" /> #1# *@
                                @*         <input type="hidden" name="nextPage" value="@Links.EngagementConcern.DateOfDecision.Page" /> *@
                                @*         <button type="submit" class="govuk-link govuk-!-padding-left-50" style="border:none; background:none; cursor:pointer;"> *@
                                @*             Change<span class="govuk-visually-hidden">Change</span> *@
                                @*         </button> *@
                                @*     </form> *@
                                @* </dd> *@
                            </div>
                        }
                    </dl>
                </div>
            </div>

            @if (Model.SupportProject.InformationPowersInUse is true)
            {
                <div class="govuk-summary-card">
                    <div class="govuk-summary-card__title-wrapper">
                        <h2 class="govuk-summary-card__title">
                            Information powers
                        </h2>
                    </div>
                    <div class="govuk-summary-card__content">
                        <dl class="govuk-summary-list">
                            <div class="govuk-summary-list__row">
                                <dt class="govuk-summary-list__key">
                                    Date used
                                </dt>
                                <dd class="govuk-summary-list__value">
                                    @Model.SupportProject.PowersUsedDate.ToDateString()
                                </dd>
                            </div>
                            <div class="govuk-summary-list__row">
                                <dt class="govuk-summary-list__key">
                                    Details
                                </dt>
                                <dd class="govuk-summary-list__value">
                                    @Model.SupportProject.InformationPowersDetails
                                </dd>
                            </div>
                        </dl>
                    </div>
                </div>
            }
            <a asp-page="@Links.EngagementConcern.RecordEngagementConcern.Page" asp-route-id="@Model.SupportProject.Id" role="button" draggable="false" class="govuk-button" data-module="govuk-button" data-cy="information-powers-btn">
                Update concern
            </a>
            <a asp-page="@Links.EngagementConcern.RecordUseOfInformationPowers.Page" asp-route-id="@Model.SupportProject.Id" role="button" draggable="false" class="govuk-button govuk-button--secondary" data-module="govuk-button" data-cy="record-information-powers-btn">
                @(Model.SupportProject.InformationPowersInUse is true ? "Update use of information powers" : "Record use of information powers")
            </a>
        }
        else
        {
            <p class="govuk-body">
                Enter details about situations where a school or responsible body does not respond to you.
            </p>
            <a asp-page="@Links.EngagementConcern.RecordEngagementConcern.Page" asp-route-id="@Model.SupportProject.Id" role="button" draggable="false" class="govuk-button govuk-button" data-module="govuk-button">
                Record engagement concern
            </a>
        }
    </div>
</div>

<script>
    function submitChangeLink(event) {
        event.preventDefault();

        const link = event.currentTarget;
        const currentUrl = window.location.href.split('?')[0];

        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `${currentUrl}?handler=ChangeLink`;

        // Add all data attributes as hidden fields
        const id = link.getAttribute('data-id');
        const returnUrl = link.getAttribute('data-return-url');
        const returnPage = link.getAttribute('data-return-page');

        const fields = {
            'Id': id,
            'ReturnUrl': returnUrl,
            'ReturnPage': returnPage,
            '__RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
        };

        // Create and append hidden fields
        Object.entries(fields).forEach(([name, value]) => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = name;
            input.value = value || '';
            form.appendChild(input);
        });

        // Add the form to the document, submit it, and remove it
        document.body.appendChild(form);
        form.submit();
        document.body.removeChild(form);
    }
</script>